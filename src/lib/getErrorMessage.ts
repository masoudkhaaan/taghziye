import { Prisma } from "$/generated/prisma";
import { fromError } from "zod-validation-error";

import { ZodError } from "zod";
import { AuthError } from "next-auth";

const PRISMA_ERROR_CODES = new Map<string, string>([
  ["P2000", "مقدار وارد شده برای ستون طولانی‌تر از حد مجاز است."],
  ["P2001", "رکوردی با شرایط مورد نظر در پایگاه داده یافت نشد."],
  ["P2002", "مقدار وارد شده در فیلدی که باید یکتا باشد، تکراری است."],
  ["P2003", "ارتباط کلید خارجی  نامعتبر است."],
  ["P2004", "یک محدودیت  در پایگاه داده نقض شده است."],
  ["P2005", "مقدار ذخیره‌شده در پایگاه داده با نوع فیلد سازگار نیست."],
  ["P2006", "مقدار وارد شده برای فیلد نامعتبر است."],
  ["P2007", "خطای اعتبارسنجی داده‌ها رخ داده است."],
  ["P2008", "تحلیل  درخواست با خطا مواجه شد."],
  ["P2009", "اعتبارسنجی درخواست با شکست مواجه شد."],
  ["P2010", "اجرای درخواست خام  با خطا مواجه شد."],
  ["P2011", "نقض محدودیت مقدار خالی "],
  ["P2012", "یک مقدار مورد نیاز ارسال نشده است."],
  ["P2013", "یک آرگومان مورد نیاز برای درخواست ارسال نشده است."],
  [
    "P2014",
    "تغییری که می‌خواهید اعمال کنید باعث نقض رابطه اجباری بین داده‌ها می‌شود.",
  ],
  ["P2015", "رکورد مرتبط مورد نظر یافت نشد."],
  ["P2016", "خطا در تفسیر  درخواست."],
  ["P2017", "رکوردهای رابطه بین مدل‌های والد و فرزند به هم متصل نیستند."],
  ["P2018", "رکوردهای مورد نیاز در ارتباط یافت نشدند."],
  ["P2019", "خطای ورودی داده‌ها."],
  ["P2020", "مقدار خارج از بازه‌ی مجاز برای نوع داده است."],
  ["P2021", "جدول مورد نظر در پایگاه داده وجود ندارد."],
  ["P2022", "ستون مورد نظر در پایگاه داده وجود ندارد."],
  ["P2023", "داده‌های ستون ناسازگار هستند."],
  ["P2024", "دریافت اتصال جدید از استخر ارتباطات زمان‌بر شد یا منقضی شد."],
  ["P2025", "عملیات انجام نشد زیرا رکورد(های) مورد نیاز یافت نشدند."],
  [
    "P2026",
    "ویژگی مورد استفاده در درخواست توسط ارائه‌دهنده‌ی پایگاه داده پشتیبانی نمی‌شود.",
  ],
  ["P2027", "چندین خطا به طور همزمان در هنگام اجرای درخواست رخ داده است."],
]);

const getErrorMessage = (error: unknown): string => {
  // خطاهای احراز هویت
  if (error instanceof AuthError) {
    return "نام کاربری یا رمز عبور اشتباه است یا کاربر یافت نشد.";
  }

  // خطاهای اعتبارسنجی داده‌ها با Zod
  if (error instanceof ZodError) {
    const message = fromError(error);
    if (message) {
      return message.toString();
    }
    return "خطای اعتبارسنجی داده‌ها رخ داده است.";
  }

  // خطاهای Prisma
  if (error instanceof Prisma.PrismaClientKnownRequestError) {
    const errorCode = error.code;
    const message = PRISMA_ERROR_CODES.get(errorCode);

    if (message) {
      return message;
    }

    // مدیریت خطای خاص برای کد P2002
    if (errorCode === "P2002") {
      const field = (error.meta?.target as string[])?.[0] || "فیلد";
      return `رکوردی با این ${field} قبلاً وجود دارد.`;
    }

    return "خطای ناشناخته‌ای در پایگاه داده رخ داده است.";
  }

  if (error instanceof Prisma.PrismaClientValidationError) {
    return "داده‌های وارد شده نامعتبر هستند.";
  }

  // سایر خطاهای عمومی
  if (error instanceof Error) {
    return error.message;
  }

  // خطای غیرمنتظره
  return "یک خطای غیرمنتظره رخ داده است.";
};
export  {getErrorMessage};
